<!DOCTYPE html>
<html>
<head>
    <title>Stripe Payment Test</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body { font-family: Arial; margin: 50px; }
        .container { max-width: 400px; margin: 0 auto; }
        input, button { padding: 10px; margin: 5px 0; width: 100%; }
        button { background: #6772e5; color: white; border: none; border-radius: 4px; }
        .result { margin: 20px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .card-element { padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <h1>üî• Stripe Payment Test</h1>
    
    <div style="text-align: center; margin-bottom: 20px;">
        <a href="/payments/status/" style="background: #17a2b8; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; display: inline-block; margin: 5px;">
            üìä View Payment Status
        </a>
        <a href="/payments/test-webhook/" style="background: #6c757d; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; display: inline-block; margin: 5px;">
            üîî Test Webhook
        </a>
    </div>
    
    <form id="payment-form">
        <label for="amount">Amount (USD):</label>
        <input type="number" id="amount" placeholder="10.00" step="0.01" required>
        
        <label for="email">Email:</label>
        <input type="email" id="email" placeholder="test@example.com" required>
        
        <label>Card Information:</label>
        <div id="card-element" class="card-element">
            <!-- Stripe Elements will create form elements here -->
        </div>
        
        <button type="submit" id="submit-button">
            üí≥ Pay Now
        </button>
    </form>
    
    <div id="result"></div>
    
    <div style="margin-top: 30px; padding: 15px; background: #f0f0f0; border-radius: 4px;">
        <h3>üìã Test Card Numbers:</h3>
        <p><strong>Success:</strong> 4242 4242 4242 4242</p>
        <p><strong>Declined:</strong> 4000 0000 0000 0002</p>
        <p><strong>Insufficient Funds:</strong> 4000 0000 0000 9995</p>
        <p><strong>Any future date + any 3 digits CVC</strong></p>
    </div>
</div>

<script>
const stripe = Stripe("{{ stripe_publishable_key }}");
const elements = stripe.elements();

// Create card element
const cardElement = elements.create('card', {
    style: {
        base: {
            fontSize: '16px',
            color: '#424770',
            '::placeholder': {
                color: '#aab7c4',
            },
        },
    },
});

cardElement.mount('#card-element');

// Handle form submission
document.getElementById('payment-form').addEventListener('submit', async (event) => {
    event.preventDefault();
    
    const submitButton = document.getElementById('submit-button');
    const resultDiv = document.getElementById('result');
    
    submitButton.disabled = true;
    submitButton.textContent = '‚è≥ Processing...';
    resultDiv.innerHTML = '';
    
    const amount = document.getElementById('amount').value;
    const email = document.getElementById('email').value;
    
    if (!amount || !email) {
        showResult('Please fill in all fields', 'error');
        resetButton();
        return;
    }
    
    try {
        // Create Payment Intent
        const response = await fetch('/payments/create-payment-intent/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ 
                amount: parseFloat(amount),
                email: email 
            })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Payment failed');
        }
        
        // Confirm payment
        const {error, paymentIntent} = await stripe.confirmCardPayment(data.client_secret, {
            payment_method: {
                card: cardElement,
                billing_details: {
                    email: email
                }
            }
        });
        
        if (error) {
            showResult(`‚ùå Payment failed: ${error.message}`, 'error');
        } else if (paymentIntent.status === 'succeeded') {
            showResult(`‚úÖ Payment succeeded! ID: ${paymentIntent.id}`, 'success');
            document.getElementById('payment-form').reset();
            cardElement.clear();
        }
        
    } catch (error) {
        showResult(`‚ùå Error: ${error.message}`, 'error');
    }
    
    resetButton();
});

function showResult(message, type) {
    const resultDiv = document.getElementById('result');
    resultDiv.innerHTML = `<div class="${type}">${message}</div>`;
}

function resetButton() {
    const submitButton = document.getElementById('submit-button');
    submitButton.disabled = false;
    submitButton.textContent = 'üí≥ Pay Now';
}

// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

</body>
</html>
