<!DOCTYPE html>
<html>
<head>
    <title>Payment Status Monitor</title>
    <meta http-equiv="refresh" content="5">
    <style>
        body { 
            font-family: Arial; 
            margin: 20px; 
            background: #f8f9fa;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            color: white;
        }
        .pending { background: #ffc107; }
        .succeeded { background: #28a745; }
        .failed { background: #dc3545; }
        .total { background: #007bff; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .status {
            padding: 5px 10px;
            border-radius: 20px;
            color: white;
            font-size: 12px;
            text-transform: uppercase;
        }
        .status.pending { background: #ffc107; }
        .status.processing { background: #17a2b8; }
        .status.approved { background: #28a745; }
        .status.succeeded { background: #20c997; }
        .status.failed { background: #dc3545; }
        .status.cancelled { background: #6c757d; }
        .status.refunded { background: #fd7e14; }
        
        .refresh-info {
            text-align: center;
            color: #6c757d;
            margin-top: 20px;
        }
        .no-payments {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .quick-actions {
            margin-bottom: 20px;
            text-align: center;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            display: inline-block;
        }
        .btn:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ’³ Payment Status Monitor</h1>
        <p>Real-time payment tracking and status updates</p>
    </div>
    
    <div class="quick-actions">
        <a href="/payments/" class="btn">ğŸ”„ Make New Payment</a>
        <a href="/payments/test-webhook/" class="btn">ğŸ”” Test Webhook</a>
        <a href="/admin/payments/payment/" class="btn">ğŸ›ï¸ Admin Panel</a>
    </div>
    
    {% if payments %}
        <div class="stats">
            <div class="stat-card total">
                <h2>{{ total_count }}</h2>
                <p>Total Payments</p>
            </div>
            <div class="stat-card pending">
                <h2>{{ pending_count }}</h2>
                <p>Pending</p>
            </div>
            <div class="stat-card" style="background: #17a2b8;">
                <h2>{{ approved_count }}</h2>
                <p>Approved</p>
            </div>
            <div class="stat-card succeeded">
                <h2>{{ succeeded_count }}</h2>
                <p>Succeeded</p>
            </div>
            <div class="stat-card failed">
                <h2>{{ failed_count }}</h2>
                <p>Failed</p>
            </div>
        </div>
        
        {% if pending_approval and user.is_authenticated and user.is_staff %}
        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 20px; margin: 20px 0;">
            <h3>âš ï¸ Payments Requiring Approval</h3>
            <div style="display: grid; gap: 15px; margin-top: 15px;">
                {% for payment in pending_approval %}
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border-radius: 4px; border: 1px solid #ddd;">
                    <div>
                        <strong>Payment #{{ payment.id }}</strong> - ${{ payment.amount }}
                        <br><small>{{ payment.created_at|date:"M d, Y H:i" }} by {{ payment.user|default:"Anonymous" }}</small>
                    </div>
                    <button onclick="approvePayment({{ payment.id }})" style="background: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;">
                        âœ… Approve
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Stripe ID</th>
                    <th>User</th>
                    <th>Created At</th>
                </tr>
            </thead>
            <tbody>
                {% for payment in payments %}
                <tr>
                    <td><strong>#{{ payment.id }}</strong></td>
                    <td>${{ payment.amount }}</td>
                    <td>
                        <span class="status {{ payment.status }}">
                            {% if payment.status == 'pending' %}â³ Pending
                            {% elif payment.status == 'processing' %}ğŸ”„ Processing  
                            {% elif payment.status == 'approved' %}âœ… Approved
                            {% elif payment.status == 'succeeded' %}ğŸ’° Succeeded
                            {% elif payment.status == 'failed' %}âŒ Failed
                            {% elif payment.status == 'cancelled' %}ğŸš« Cancelled
                            {% elif payment.status == 'refunded' %}â†©ï¸ Refunded
                            {% else %}{{ payment.status }}
                            {% endif %}
                        </span>
                        {% if payment.approved_by %}
                            <br><small>by {{ payment.approved_by.username }}</small>
                        {% endif %}
                    </td>
                    <td><code>{{ payment.stripe_payment_intent|truncatechars:20 }}</code></td>
                    <td>{{ payment.user|default:"Anonymous" }}</td>
                    <td>{{ payment.created_at|date:"M d, Y H:i:s" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="no-payments">
            <h3>ğŸš« No payments found</h3>
            <p>Make your first payment to see status updates here.</p>
            <a href="/payments/" class="btn">ğŸ’³ Make Payment</a>
        </div>
    {% endif %}
    
    <div class="refresh-info">
        <p>ğŸ”„ Page auto-refreshes every 5 seconds to show latest status</p>
        <p><small>Last updated: {{ "now"|date:"M d, Y H:i:s" }}</small></p>
    </div>
</div>

<script>
// Add some real-time feel
let dots = 0;
setInterval(() => {
    dots = (dots + 1) % 4;
    const elements = document.querySelectorAll('.status.pending');
    elements.forEach(el => {
        el.innerHTML = 'â³ Pending' + '.'.repeat(dots);
    });
}, 500);

// Highlight new succeeded payments
document.addEventListener('DOMContentLoaded', function() {
    const succeededRows = document.querySelectorAll('.status.succeeded');
    succeededRows.forEach(row => {
        const tr = row.closest('tr');
        tr.style.background = '#d4edda';
        tr.style.border = '2px solid #28a745';
        
        // Flash effect for succeeded payments
        setTimeout(() => {
            tr.style.background = '';
            tr.style.border = '';
        }, 3000);
    });
});

// Approval function
async function approvePayment(paymentId) {
    if (confirm(`Are you sure you want to approve Payment #${paymentId}?`)) {
        try {
            const response = await fetch(`/payments/approve/${paymentId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: `notes=Approved via dashboard`
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert(`âœ… ${result.message}`);
                location.reload(); // Refresh page to show updated status
            } else {
                alert(`âŒ ${result.message}`);
            }
            
        } catch (error) {
            alert(`âŒ Error: ${error.message}`);
        }
    }
}

// Get CSRF token function
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

</body>
</html>